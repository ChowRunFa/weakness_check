# æ–½å·¥æ–¹æ¡ˆå®¡æ ¸ç³»ç»Ÿ API

åŸºäºRAGï¼ˆRetrieval-Augmented Generationï¼‰æŠ€æœ¯çš„å»ºè®¾å·¥ç¨‹æ–½å·¥æ–¹æ¡ˆç¼ºé™·æ£€æŸ¥ç³»ç»Ÿã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
check_backend/
â”œâ”€â”€ app.py                           # ğŸš€ ä¸»åº”ç”¨å…¥å£
â”œâ”€â”€ requirements.txt                 # ğŸ“¦ ä¾èµ–åŒ…é…ç½®
â”œâ”€â”€ README.md                       # ğŸ“– é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ apis/                           # ğŸ”Œ APIæ¥å£
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ api_ra_check.py            # æ–½å·¥æ–¹æ¡ˆå®¡æ ¸API
â”‚   â”œâ”€â”€ api_upload.py              # æ–‡ä»¶ä¸Šä¼ API
â”‚   â”œâ”€â”€ api_report.py              # æŠ¥å‘Šç”ŸæˆAPI
â”‚   â””â”€â”€ ...                        # å…¶ä»–APIæ–‡ä»¶
â”œâ”€â”€ objs/                          # ğŸ§© æ ¸å¿ƒå¯¹è±¡ç±»
â”‚   â”œâ”€â”€ PlanAuditor.py            # æ–½å·¥æ–¹æ¡ˆå®¡æ ¸å™¨
â”‚   â””â”€â”€ EmbeddingRetriever.py     # æ–‡æœ¬åµŒå…¥æ£€ç´¢å™¨
â”œâ”€â”€ utils/                         # ğŸ› ï¸ å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ prompts.py                # æç¤ºè¯æ¨¡æ¿
â”‚   â””â”€â”€ swagger_configs/          # Swaggeré…ç½®
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ ra_check_swagger.py   # ra_check APIæ–‡æ¡£é…ç½®
â”œâ”€â”€ func_test/                     # ğŸ§ª åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_ra_check.py          # ra_checkåŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ data/                          # ğŸ“Š æ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ weakness_list.jsonl       # æ£€æŸ¥é¡¹é…ç½®
â”œâ”€â”€ cache/                         # ğŸ’¾ ç¼“å­˜ç›®å½•
â”œâ”€â”€ uploads/                       # ğŸ“ ä¸Šä¼ æ–‡ä»¶ç›®å½•
â”œâ”€â”€ config/                        # âš™ï¸ é…ç½®æ–‡ä»¶
â”œâ”€â”€ db/                           # ğŸ—„ï¸ æ•°æ®åº“ç›¸å…³
â””â”€â”€ ...
```

## åŠŸèƒ½ç‰¹æ€§

- **æ–‡æ¡£ä¸Šä¼ **: æ”¯æŒdocxã€docã€txtã€pdfæ ¼å¼çš„æ–½å·¥æ–¹æ¡ˆæ–‡æ¡£ä¸Šä¼ 
- **æ™ºèƒ½æ£€ç´¢**: åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„æ–¹æ¡ˆå†…å®¹æ£€ç´¢
- **åˆ†ç±»æ£€æŸ¥**: æŒ‰ç…§ä¸åŒç±»åˆ«å’Œåœºæ™¯è¿›è¡Œä¸“é¡¹ç¼ºé™·æ£€æŸ¥
- **å®Œæ•´å®¡æ ¸**: å¯¹æ–½å·¥æ–¹æ¡ˆè¿›è¡Œå…¨é¢çš„ç¼ºé™·å®¡æ ¸å¹¶ç”ŸæˆæŠ¥å‘Š
- **APIæ–‡æ¡£**: å®Œæ•´çš„Swagger APIæ–‡æ¡£æ”¯æŒ

## å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

## å¯åŠ¨æœåŠ¡

```bash
python app.py
```

æœåŠ¡å¯åŠ¨åè®¿é—® http://localhost:5000/swagger/ æŸ¥çœ‹å®Œæ•´çš„APIæ–‡æ¡£ã€‚

## ä¸»è¦APIæ¥å£

### 1. ä¸Šä¼ æ–½å·¥æ–¹æ¡ˆ `/ra_check/upload_plan`

**POST** - ä¸Šä¼ æ–½å·¥æ–¹æ¡ˆæ–‡æ¡£å¹¶è¿›è¡Œæ–‡æœ¬æå–å’Œå‘é‡åŒ–å¤„ç†

**å‚æ•°:**
- `file`: æ–½å·¥æ–¹æ¡ˆæ–‡æ¡£æ–‡ä»¶
- `embedding_model`: åµŒå…¥æ¨¡å‹åç§°ï¼ˆå¯é€‰ï¼‰
- `openai_api_key`: APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰
- `openai_api_base`: APIåŸºç¡€URLï¼ˆå¯é€‰ï¼‰

**è¿”å›:**
```json
{
    "status": "success",
    "message": "æ–‡æ¡£ä¸Šä¼ æˆåŠŸ",
    "plan_id": "abc123456789",
    "text_length": 15420,
    "chunks_count": 52
}
```

### 2. æŸ¥è¯¢æ–¹æ¡ˆå†…å®¹ `/ra_check/query`

**POST** - æ ¹æ®æŸ¥è¯¢æ–‡æœ¬ä»å·²ä¸Šä¼ çš„æ–½å·¥æ–¹æ¡ˆä¸­æ£€ç´¢ç›¸å…³å†…å®¹

**å‚æ•°:**
```json
{
    "plan_id": "abc123456789",
    "query": "å®‰å…¨é˜²æŠ¤æªæ–½",
    "top_k": 5
}
```

**è¿”å›:**
```json
{
    "status": "success",
    "results": [
        {
            "text": "ç›¸å…³æ–‡æœ¬å†…å®¹...",
            "similarity": 0.8542,
            "index": 15
        }
    ]
}
```

### 3. åˆ†ç±»åœºæ™¯æ£€æŸ¥ `/ra_check/check_category`

**POST** - æ ¹æ®æŒ‡å®šçš„ç±»åˆ«å’Œåœºæ™¯å¯¹æ–½å·¥æ–¹æ¡ˆè¿›è¡Œä¸“é¡¹æ£€æŸ¥

**å‚æ•°:**
```json
{
    "plan_id": "abc123456789",
    "category": "å®‰å…¨ç®¡ç†",
    "scenario": "å®‰å…¨ç”Ÿäº§è´£ä»»åˆ¶",
    "top_k": 5
}
```

### 4. å®Œæ•´å®¡æ ¸ `/ra_check/full_audit`

**POST** - å¯¹æ–½å·¥æ–¹æ¡ˆè¿›è¡Œå…¨é¢çš„ç¼ºé™·å®¡æ ¸ï¼Œç”Ÿæˆè¯¦ç»†çš„å®¡æ ¸æŠ¥å‘Š

**å‚æ•°:**
```json
{
    "plan_id": "abc123456789",
    "check_categories": ["å®‰å…¨ç®¡ç†", "è´¨é‡æ§åˆ¶"]
}
```

### 5. æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ `/ra_check/status`

**GET** - æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­å·²åŠ è½½çš„æ–¹æ¡ˆå’Œç³»ç»Ÿé…ç½®ä¿¡æ¯

## ä½¿ç”¨ç¤ºä¾‹

### 1. Python å®¢æˆ·ç«¯ç¤ºä¾‹

```python
import requests
import json

# 1. ä¸Šä¼ æ–‡æ¡£
files = {'file': open('æ–½å·¥æ–¹æ¡ˆ.docx', 'rb')}
response = requests.post('http://localhost:5000/ra_check/upload_plan', files=files)
result = response.json()
plan_id = result['plan_id']

# 2. æŸ¥è¯¢å†…å®¹
query_data = {
    "plan_id": plan_id,
    "query": "å®‰å…¨é˜²æŠ¤æªæ–½",
    "top_k": 3
}
response = requests.post('http://localhost:5000/ra_check/query', json=query_data)
results = response.json()

# 3. å®Œæ•´å®¡æ ¸
audit_data = {
    "plan_id": plan_id,
    "check_categories": ["å®‰å…¨ç®¡ç†", "è´¨é‡æ§åˆ¶"]
}
response = requests.post('http://localhost:5000/ra_check/full_audit', json=audit_data)
audit_results = response.json()
```

### 2. cURL ç¤ºä¾‹

```bash
# ä¸Šä¼ æ–‡æ¡£
curl -X POST -F "file=@æ–½å·¥æ–¹æ¡ˆ.docx" http://localhost:5000/ra_check/upload_plan

# æŸ¥è¯¢å†…å®¹
curl -X POST -H "Content-Type: application/json" \
     -d '{"plan_id":"abc123","query":"å®‰å…¨æªæ–½","top_k":5}' \
     http://localhost:5000/ra_check/query

# æŸ¥çœ‹çŠ¶æ€
curl -X GET http://localhost:5000/ra_check/status
```

## è¿è¡Œæµ‹è¯•

```bash
# è¿è¡ŒåŠŸèƒ½æµ‹è¯•
python func_test/test_ra_check.py

# æˆ–è€…ä½œä¸ºæ¨¡å—è¿è¡Œ
python -m func_test.test_ra_check
```

## é…ç½®è¯´æ˜

### åµŒå…¥æ¨¡å‹é…ç½®

ç³»ç»Ÿæ”¯æŒOpenAIå…¼å®¹çš„åµŒå…¥æ¨¡å‹ï¼ŒåŒ…æ‹¬ï¼š
- OpenAIå®˜æ–¹æ¨¡å‹ï¼ˆå¦‚ text-embedding-3-smallï¼‰
- æœ¬åœ°Ollamaéƒ¨ç½²çš„æ¨¡å‹ï¼ˆå¦‚ nomic-embed-textï¼‰

### æ£€æŸ¥é¡¹é…ç½®

æ£€æŸ¥é¡¹é€šè¿‡ `data/weakness_list.jsonl` æ–‡ä»¶é…ç½®ï¼Œæ¯è¡Œä¸€ä¸ªJSONå¯¹è±¡ï¼š

```json
{"åˆ†ç±»": "å®‰å…¨ç®¡ç†", "åºå·": "1", "ä¸“é¡¹æ–½å·¥æ–¹æ¡ˆä¸¥é‡ç¼ºé™·æƒ…å½¢": "æœªå»ºç«‹å®‰å…¨ç”Ÿäº§è´£ä»»åˆ¶æˆ–è´£ä»»åˆ¶ä¸å®Œå–„"}
```

### ç¼“å­˜é…ç½®

- æ–‡æœ¬å‘é‡ç¼“å­˜ç›®å½•ï¼š`cache/`
- ä¸Šä¼ æ–‡ä»¶ç›®å½•ï¼š`uploads/`

## æŠ€æœ¯æ¶æ„

- **Flask**: Webæ¡†æ¶
- **Flasgger**: APIæ–‡æ¡£ç”Ÿæˆ
- **FAISS**: å‘é‡ç›¸ä¼¼åº¦æœç´¢
- **OpenAI**: æ–‡æœ¬åµŒå…¥æ¨¡å‹æ¥å£
- **python-docx**: Wordæ–‡æ¡£è§£æ

## å¼€å‘è§„èŒƒ

### æ–‡ä»¶ç»„ç»‡åŸåˆ™

- **`app.py`**: ä¸»åº”ç”¨å…¥å£ï¼Œä¿æŒç®€æ´
- **`apis/`**: æ‰€æœ‰APIè“å›¾æ–‡ä»¶
- **`objs/`**: æ ¸å¿ƒä¸šåŠ¡å¯¹è±¡ç±»
- **`utils/`**: å·¥å…·å‡½æ•°å’Œé…ç½®
- **`func_test/`**: åŠŸèƒ½æµ‹è¯•ä»£ç 
- **`data/`**: æ•°æ®æ–‡ä»¶å’Œé…ç½®

### Swaggeræ–‡æ¡£é…ç½®

- APIæ–‡æ¡£é…ç½®ç»Ÿä¸€å­˜æ”¾åœ¨ `utils/swagger_configs/`
- æ¯ä¸ªAPIæ¨¡å—æœ‰å¯¹åº”çš„é…ç½®æ–‡ä»¶
- APIè·¯ç”±é€šè¿‡ `@swag_from(config_variable)` å¼•ç”¨é…ç½®

## æ³¨æ„äº‹é¡¹

1. é¦–æ¬¡ä¸Šä¼ æ–‡æ¡£æ—¶ä¼šè¿›è¡Œæ–‡æœ¬åµŒå…¥ï¼Œå¤„ç†æ—¶é—´è¾ƒé•¿
2. åµŒå…¥ç»“æœä¼šè‡ªåŠ¨ç¼“å­˜ï¼Œå†æ¬¡ä¸Šä¼ ç›¸åŒå†…å®¹çš„æ–‡æ¡£ä¼šå¿«é€ŸåŠ è½½
3. ç³»ç»Ÿä½¿ç”¨å†…å­˜ç¼“å­˜æ–¹æ¡ˆå®ä¾‹ï¼Œé‡å¯æœåŠ¡åéœ€è¦é‡æ–°ä¸Šä¼ æ–‡æ¡£
4. å»ºè®®é…ç½®è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ç”¨äºå‘é‡å­˜å‚¨å’Œè®¡ç®—

## é”™è¯¯å¤„ç†

æ‰€æœ‰APIéƒ½è¿”å›ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼ï¼š

```json
{
    "status": "error",
    "message": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

å¸¸è§é”™è¯¯ç ï¼š
- 400: è¯·æ±‚å‚æ•°é”™è¯¯
- 404: æ–¹æ¡ˆæœªæ‰¾åˆ°
- 500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ 